<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Index Page</title>
  <h1 id="welcomeMessage">欢迎访问</h1>
</head>
<body>
  <label for="store">店舗を選択:</label>
  <select id="store">
    <option value="store1">店舗1</option>
    <option value="store2">店舗2</option>
    <option value="store3">店舗3</option>
  </select>

  <div id="categories">
    <label><input type="checkbox" value="cat1">カテゴリー1</label>
    <label><input type="checkbox" value="cat2">カテゴリー2</label>
    <label><input type="checkbox" value="cat3">カテゴリー3</label>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const username = urlParams.get('username');
      const welcomeMessageElement = document.getElementById('welcomeMessage');

      if (welcomeMessageElement) {
        welcomeMessageElement.textContent = username ? `你好，${username}` : '欢迎访问';
      }

      const storeSelect = document.getElementById('store');
      const categoriesDiv = document.getElementById('categories');
      const categoryCheckboxes = categoriesDiv.querySelectorAll('input[type="checkbox"]');
      const savedData = JSON.parse(localStorage.getItem('storeCategories')) || {};

        // 初始化loacal商店选择
  if (savedData.selectedStore) {
    storeSelect.value = savedData.selectedStore;
  }

  // 初始化类别复选框
  if (savedData.categories && savedData.categories[savedData.selectedStore]) {
    const savedCategories = savedData.categories[savedData.selectedStore];
    categoryCheckboxes.forEach(checkbox => {
      checkbox.checked = savedCategories.includes(checkbox.value);
    });
  }
      // 监听商店选择的变化
      storeSelect.addEventListener('change', handleDataChange);
      categoryCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', handleDataChange);
      });

// 监听商店选择的变化
      storeSelect.addEventListener('change', () => {
    const selectedStore = storeSelect.value;
    if (savedData.categories && savedData.categories[selectedStore]) {
      const savedCategories = savedData.categories[selectedStore];
      categoryCheckboxes.forEach(checkbox => {
        checkbox.checked = savedCategories.includes(checkbox.value);
      });
    } else {
      categoryCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
      });
    }
    localSaveData();
  });

    // 监听类别复选框的变化
    categoryCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', localSaveData);
  });
      
  // 保存数据的函数
  function localSaveData() {
    const selectedStore = storeSelect.value;
    const selectedCategories = Array.from(categoryCheckboxes)
      .filter(checkbox => checkbox.checked)
      .map(checkbox => checkbox.value);

    savedData.selectedStore = selectedStore;
    if (!savedData.categories) {
      savedData.categories = {};
    }
    savedData.categories[selectedStore] = selectedCategories;

    localStorage.setItem('storeCategories', JSON.stringify(savedData));
  }

      // 初始化商店选择
      if (username) {
        try {
          const response = await fetch(`/getUserData?username=${encodeURIComponent(username)}`);
          const data = await response.json();
          if (data) {
            loadUserData(data);
          }
        } catch (error) {
          console.error('Error fetching user data:', error);
        }
      }

      function handleDataChange() {
        saveData();
      }

      function saveData() {
        const selectedStore = storeSelect.value;
        const selectedCategories = Array.from(categoryCheckboxes)
          .filter(checkbox => checkbox.checked)
          .map(checkbox => checkbox.value);

        if (!username) return;

        const data = {
          username,
          selectedStore,
          selectedCategories
        };

        fetch('/saveUserData', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        }).then(response => response.text())
          .then(data => console.log(data))
          .catch(error => console.error('Error saving data:', error));
      }

      function loadUserData(data) {
        storeSelect.value = data.selected_store;
        const savedCategories = JSON.parse(data.selected_categories);

        categoryCheckboxes.forEach(checkbox => {
          checkbox.checked = savedCategories.includes(checkbox.value);
        });
      }

      window.addEventListener('beforeunload', saveData);
    });
  </script>
</body>
</html>
